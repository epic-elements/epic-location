<link rel="import"
	href="../polymer/polymer.html">
<link rel="import"
	href="../epic-polyfills/babel-polyfill.html">
<link rel="import"
	href="uri.html">
<link rel="import"
	href="../app-route/app-route-converter.html">
<link rel="import"
	href="../iron-location/iron-query-params.html">
<link rel="import"
	href="../epic-stream/src/xstream.html">

<!--
`epic-location`
watches address bar for changes

@demo demo/index.html
-->

<dom-module id="epic-location">
	<template>
		<iron-query-params id="ironQueryParams"
			params-string="[[query]]"
			params-object="{{_queryParams}}">
		</iron-query-params>
		<app-route-converter id="appRouteConverter"
			path="[[pathname]]"
			query-params="[[_queryParams]]">
		</app-route-converter>
	</template>
	<script>
		Polymer({
			is: 'epic-location',
			properties: {
				ignorePopstate: {
					type: Boolean,
					value: false,
					notify: true
				},
				ignoreHash: {
					type: Boolean,
					value: false,
					notify: true
				},
				ignoreClicks: {
					type: Boolean,
					value: false,
					notify: true
				},
				url: {
					type: String,
					value: '',
					notify: true
				},
				hostname: {
					type: String,
					notify: true,
					readOnly: true
				},
				query: {
					type: String,
					notify: true,
					readOnly: true
				},
				pathname: {
					type: String,
					notify: true,
					readOnly: true
				},
				route: {
					type: Object,
					notify: true,
					readOnly: true
				}
			},
			ready: function() {
				// streams of property changes
				var urlChanges$ = xs.fromEvent(this, 'url-changed')
					.map(e => e.detail.value)
					.startWith(this.url)
					.map(url => url || window.location.href)
					.remember();
				// streams to process changes
				var urlObj$ = urlChanges$.map(href => new URI(href));
				// streams of properties to update
				var hostname$ = urlObj$
					.map(url => url.hostname());
				var query$ = urlObj$.map(url => url.query());
				var pathname$ = urlObj$.map(url => url.pathname());
				var domain$ = urlObj$.map(url => url.domain());

				// Child property changes
				var route$ = xs.fromEvent(this.$.appRouteConverter, 'route-changed')
					.map(e => e.detail.value)
					.startWith(this.$.appRouteConverter.route)
					.remember();

				this.state$ = xs
					.combine(hostname$, query$, pathname$, route$)
					.map(([hostname, query, pathname, route]) => Object.assign({}, {
						hostname,
						query,
						pathname,
						route: route
					}))
					.compose(xs.debounce(100));
			},
			attached: function() {
				this.mainListener = {
					next: state => {
						this._setHostname(state.hostname);
						this._setQuery(state.query);
						this._setPathname(state.pathname);
						this._setRoute(state.route)
					},
					error: err => console.error(err),
					complete: () => console.log('completed')
				}
				this.state$.addListener(this.mainListener);
			},
			detached: function() {
				this.state$.removeListener(this.mainListener);
			}
		})
	</script>
</dom-module>
