<link rel="import"
	href="../polymer/polymer.html">
<link rel="import"
	href="../epic-polyfills/babel-polyfill.html">
<link rel="import"
	href="uri.html">
<link rel="import"
	href="../app-route/app-route-converter.html">
<link rel="import"
	href="../iron-location/iron-query-params.html">
<link rel="import"
	href="../epic-stream/src/epic-stream-behavior.html">
<link rel="import"
	href="../epic-stream/src/xstream.html">

<!--
`epic-location`
watches address bar for changes

@demo demo/index.html
-->

<dom-module id="epic-location">
	<template>
		<!-- <iron-query-params id="ironQueryParams"
			params-string="[[query]]"
			params-object="{{_queryParams}}">
		</iron-query-params>
		<app-route-converter id="appRouteConverter"
			path="[[pathname]]"
			query-params="[[queryParams]]"
			route="{{_route}}">
		</app-route-converter> -->
	</template>
	<script>
		Polymer({
			is: 'epic-location',
			behaviors: [Polymer.Epic.StreamBehavior],
			properties: {
				ignorePopstate: {
					type: Boolean,
					value: false,
					notify: true
				},
				ignoreHash: {
					type: Boolean,
					value: false,
					notify: true
				},
				ignoreClicks: {
					type: Boolean,
					value: false,
					notify: true
				},
				urlOverride: {
					type: String,
					value: '',
					notify: true
				},
				hostname: {
					type: String,
					value: '',
					notify: true,
					readOnly: true
				}
				// lifecycle$: {
				// 	type: Object,
				// 	value: function() {
				// 		return new Rx.ReplaySubject();
				// 	},
				// 	notify: true,
				// 	readOnly: true
				// },
				// readyLifecycle$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createReadyLifecycleStream(lifecycle$)',
				// 	readOnly: true
				// },
				// attachedLifecycle$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createAttachedLifecycleStream(lifecycle$)',
				// 	readOnly: true
				// },
				// detachedLifecycle$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createDetachedLifecycleStream(lifecycle$)',
				// 	readOnly: true
				// },
				// observePopstates$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createObservePopstatesStream(readyLifecycle$)',
				// 	readOnly: true
				// },
				// observeHashChanges$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createObserveHashChanges(readyLifecycle$)',
				// 	readOnly: true
				// },
				// observeClicks$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createObserveClicks(readyLifecycle$)',
				// 	readOnly: true
				// },
				// popstates$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createPopstateStream(attachedLifecycle$, observePopstates$)',
				// 	readOnly: true
				// },
				// hashChanges$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createHashChangeStream(attachedLifecycle$, observeHashChanges$)',
				// 	readOnly: true
				// },
				// clicks$: {
				// 	type: Object,
				// 	notify: true,
				// 	computed: '_createClickStream(attachedLifecycle$, observeClicks$)',
				// 	readOnly: true
				// },
			},
			ready: function() {
				// var properties$ = this._createStreamFromProperies();
				var lifecycle$ = this._createStreamFromLifecycleChanges();
				var attached$ = lifecycle$.filter(v => v === 'attached');
				var detached$ = lifecycle$.filter(v => v === 'detached');
				var url$ = xs.of(window.location.href)
				var urlObj$ = url$.map(href => new URI(href));
				var hostname$ = urlObj$.map(url => url.hostname());
				var domain$ = urlObj$.map(url => url.domain());

				var state$ = attached$.map(v => xs
						.combine(hostname$)
						.map(([hostname]) => Object.assign({}, {
							hostname
						}))
						.debug(x => x)
						.endWhen(detached$))
					.compose(xs.flattenConcurrently);

				var updateHostname$ = state$
					.map(state => state.hostname)
					.compose(xs.dropRepeats());
				updateHostname$.addListener({
					next: v => this._setHostname(v),
					error: err => console.error(err),
					complete: () => console.log('completed')
				})

			},
			attached: function() {



				// this.set('observePopstates', true);
				// this.set('observePopstates', true);
				// this.set('observePopstates', false);
				// this.set('observeHashChanges', true);
				// this.set('observeHashChanges', true);
				// this.set('observeHashChanges', false);
				// this.set('observeClicks', true);
				// this.set('observeClicks', true);
				// this.set('observeClicks', false);
			},
			detached: function() {
				// this.lifecycle$.next('detached');
			},
			// _createReadyLifecycleStream: function(lifecycle$) {
			// 	return lifecycle$
			// 		.filter(v => v === 'ready')
			// },
			// _createAttachedLifecycleStream: function(lifecycle$) {
			// 	return lifecycle$
			// 		.filter(v => v === 'attached')
			// },
			// _createDetachedLifecycleStream: function(lifecycle$) {
			// 	return lifecycle$
			// 		.filter(v => v === 'detached')
			// },
			// _createObservePopstatesStream: function(readyLifecycle$) {
			// 	return this
			// 		._createPropertyStream('observePopstates')
			// 		.filter(v => v)
			// 		.skipUntil(readyLifecycle$);
			// },
			// _createObserveHashChangeStream: function(readyLifecycle$) {
			// 	return this
			// 		._createPropertyStream('observeHashChanges')
			// 		.filter(v => v)
			// 		.skipUntil(readyLifecycle$);
			// },
			// _createObserveClickStream: function(readyLifecycle$) {
			// 	return this
			// 		._createPropertyStream('observeClicks')
			// 		.filter(v => v)
			// 		.skipUntil(readyLifecycle$);
			// },
			// _createPopstateStream: function(attachedLifecycle$, observePopstates$) {
			// 	return observePopstates$
			// 		.switch(Rx.Observable
			// 			.fromEvent(window, 'popstate'))
			// 		.skipUntil(attachedLifecycle$);
			// },
			// _createHashChangeStream: function(attachedLifecycle$, observeHashChanges$) {
			// 	return observePopstates$
			// 		.switch(Rx.Observable
			// 			.fromEvent(window, 'hashchange'))
			// 		.skipUntil(attachedLifecycle$);
			// },
			// _createClickStream: function(attachedLifecycle$, observeClicks$) {
			// 	return observePopstates$
			// 		.switch(Rx.Observable
			// 			.fromEvent(document, 'click'))
			// 		.skipUntil(attachedLifecycle$);
			// },

		})
	</script>
</dom-module>
