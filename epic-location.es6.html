<link rel="import"
	href="../polymer/polymer.html">
<link rel="import"
	href="../epic-polyfills/babel-polyfill.html">
<link rel="import"
	href="uri.html">
<link rel="import"
	href="../app-route/app-route-converter.html">
<link rel="import"
	href="../iron-location/iron-query-params.html">
<link rel="import"
	href="../epic-stream/src/epic-stream-behavior.html">
<link rel="import"
	href="../epic-stream/src/xstream.html">

<!--
`epic-location`
watches address bar for changes

@demo demo/index.html
-->

<dom-module id="epic-location">
	<template>
		<iron-query-params id="ironQueryParams"
			params-string="[[query]]"
			params-object="{{_queryParams}}">
		</iron-query-params>
		<app-route-converter id="appRouteConverter"
			path="[[pathname]]"
			query-params="[[_queryParams]]">
		</app-route-converter>
	</template>
	<script>
		Polymer({
			is: 'epic-location',
			behaviors: [Polymer.Epic.StreamBehavior],
			properties: {
				ignorePopstate: {
					type: Boolean,
					value: false,
					notify: true
				},
				ignoreHash: {
					type: Boolean,
					value: false,
					notify: true
				},
				ignoreClicks: {
					type: Boolean,
					value: false,
					notify: true
				},
				url: {
					type: String,
					value: '',
					notify: true
				},
				hostname: {
					type: String,
					notify: true,
					readOnly: true
				},
				query: {
					type: String,
					notify: true,
					readOnly: true
				},
				pathname: {
					type: String,
					notify: true,
					readOnly: true
				},
				route: {
					type: Object,
					notify: true,
					readOnly: true
				}
			},
			ready: function() {
				// Streams of lifecycle changes
				var lifecycleChanges$ = this._createStreamFromLifecycleChanges()
					.remember();
				var attached$ = lifecycleChanges$.filter(v => v === 'attached').remember();
				var detached$ = lifecycleChanges$.filter(v => v === 'detached').remember();

				// streams of property changes
				var urlChanges$ = xs.fromEvent(this, 'url-changed')
					.map(e => e.detail.value)
					.startWith(this.url)
					.map(url => url || window.location.href)
					.remember();
				// streams to process changes
				var urlObj$ = urlChanges$.map(href => new URI(href));
				// streams of properties to update
				var hostname$ = urlObj$
					.map(url => url.hostname());
				var query$ = urlObj$.map(url => url.query());
				var pathname$ = urlObj$.map(url => url.pathname());
				var domain$ = urlObj$.map(url => url.domain());

				// Child property changes
				var route$ = xs.fromEvent(this.$.appRouteConverter, 'route-changed')
					.map(e => e.detail.value)
					.startWith(this.$.appRouteConverter.route)
					.remember();

				var state$ = attached$.map(v => xs
						.combine(hostname$, query$, pathname$, route$)
						.map(([hostname, query, pathname, route]) => Object.assign({}, {
							hostname,
							query,
							pathname,
							route: route
						}))
						.endWhen(detached$))
					.compose(xs.flattenConcurrently)
					.compose(xs.debounce(100));

				var updateHostname$ = state$
					.map(state => state.hostname)
					.compose(xs.dropRepeats());
				updateHostname$.addListener({
					next: v => this._setHostname(v),
					error: err => console.error(err)
				});
				var updateQuery$ = state$
					.map(state => state.query)
					.compose(xs.dropRepeats());
				updateQuery$.addListener({
					next: v => this._setQuery(v),
					error: err => console.error(err)
				});
				var updatePathname$ = state$
					.map(state => state.pathname)
					.compose(xs.dropRepeats());
				updatePathname$.addListener({
					next: v => this._setPathname(v),
					error: err => console.error(err)
				});
				var updateRoute$ = state$
					.map(state => state.route)
					.compose(xs.dropRepeats());
				updateRoute$.addListener({
					next: v => this._setRoute(v),
					error: err => console.error(err)
				});
			},
			attached: function() {



				// this.set('observePopstates', true);
				// this.set('observePopstates', true);
				// this.set('observePopstates', false);
				// this.set('observeHashChanges', true);
				// this.set('observeHashChanges', true);
				// this.set('observeHashChanges', false);
				// this.set('observeClicks', true);
				// this.set('observeClicks', true);
				// this.set('observeClicks', false);
			},
			detached: function() {
				// this.lifecycle$.next('detached');
			},
			// _createReadyLifecycleStream: function(lifecycle$) {
			// 	return lifecycle$
			// 		.filter(v => v === 'ready')
			// },
			// _createAttachedLifecycleStream: function(lifecycle$) {
			// 	return lifecycle$
			// 		.filter(v => v === 'attached')
			// },
			// _createDetachedLifecycleStream: function(lifecycle$) {
			// 	return lifecycle$
			// 		.filter(v => v === 'detached')
			// },
			// _createObservePopstatesStream: function(readyLifecycle$) {
			// 	return this
			// 		._createPropertyStream('observePopstates')
			// 		.filter(v => v)
			// 		.skipUntil(readyLifecycle$);
			// },
			// _createObserveHashChangeStream: function(readyLifecycle$) {
			// 	return this
			// 		._createPropertyStream('observeHashChanges')
			// 		.filter(v => v)
			// 		.skipUntil(readyLifecycle$);
			// },
			// _createObserveClickStream: function(readyLifecycle$) {
			// 	return this
			// 		._createPropertyStream('observeClicks')
			// 		.filter(v => v)
			// 		.skipUntil(readyLifecycle$);
			// },
			// _createPopstateStream: function(attachedLifecycle$, observePopstates$) {
			// 	return observePopstates$
			// 		.switch(Rx.Observable
			// 			.fromEvent(window, 'popstate'))
			// 		.skipUntil(attachedLifecycle$);
			// },
			// _createHashChangeStream: function(attachedLifecycle$, observeHashChanges$) {
			// 	return observePopstates$
			// 		.switch(Rx.Observable
			// 			.fromEvent(window, 'hashchange'))
			// 		.skipUntil(attachedLifecycle$);
			// },
			// _createClickStream: function(attachedLifecycle$, observeClicks$) {
			// 	return observePopstates$
			// 		.switch(Rx.Observable
			// 			.fromEvent(document, 'click'))
			// 		.skipUntil(attachedLifecycle$);
			// },

		})
	</script>
</dom-module>
